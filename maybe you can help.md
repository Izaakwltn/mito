{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Hi Fukamachi-san,\n",
    "\n",
    "I am interested in using mito (and sxql, etc.) for a small project I am working on, called ClassStarter.\n",
    "\n",
    "ClassStarter will be an auction market for classes at my Hackerspace, **Freeside Atlanta**.\n",
    "\n",
    "I am starting by connecting to Sqlite3, but will probably migrate it to Postgres, so Mito seems perfect.\n",
    "\n",
    "I have been able to create tables, and add records to some tables, but am having problems with adding records that depend on other records.\n",
    "\n",
    "For instance, one table holds records for **person**, and each **person** has a **role**.\n",
    "\n",
    "**role** is a separate, small table to condense data and avoid spelling errors and so on.\n",
    "\n",
    "\n",
    "Here is a simplified case showing the problem I am having.\n",
    "\n",
    "I did some edits on the mito README, to try to help you out, and not just ask for help.\n",
    "\n",
    "I hope you can help me get over this issue.\n",
    "\n",
    "\n",
    "## **File: /home/gt/gitstuff/classstarter/package.lisp**\n",
    "\n",
    "```\n",
    ";;;; From ./package.lisp\n",
    "\n",
    "(ql:quickload :mito)\n",
    "\n",
    "(defpackage #:classstarter\n",
    "  (:use\n",
    "   #:common-lisp\n",
    "   #:mito))\n",
    "\n",
    "(in-package :classstarter)\n",
    "\n",
    "(mito:connect-toplevel :sqlite3 :database-name \"/home/gt/test.sqlite3\")\n",
    "\n",
    "(mito:deftable role ()\n",
    "  ((name :col-type (:varchar 64))))\n",
    "\n",
    "(mito:deftable person ()\n",
    "  ((name :col-type (:varchar 64))\n",
    "   (role :col-type role)))\n",
    "\n",
    "(mapc #'mito:execute-sql (mito:table-definition 'role))\n",
    "(mapc #'mito:execute-sql (mito:table-definition 'person))\n",
    "\n",
    "(defun create-roles (role-names)\n",
    "  (mapc (lambda (x) (mito:create-dao 'role :name x)) role-names))\n",
    "\n",
    ";(setf role-namen '(\"Instructor\" \"Student\"))\n",
    "\n",
    ";(create-roles role-namen)\n",
    "\n",
    "(defun create-person ()\n",
    "  (mito:create-dao 'person :name \"Jud Taylor\" :role 1))\n",
    "\n",
    "```\n",
    "  \n",
    "## **At REPL:**\n",
    "\n",
    "```\n",
    "; Restarting inferior lisp process\n",
    "; --------------------------------------------------------\n",
    "; Dedicated output stream setup (port 44285)\n",
    "; Redirecting all output to this MREPL\n",
    "; SLY 1.0.0-beta-3 (#<MREPL mrepl-1-1>)\n",
    "CL-USER> (load \"/home/gt/gitstuff/classstarter/class-starter-test.lisp\")\n",
    "To load \"mito\":\n",
    "  Load 1 ASDF system:\n",
    "    mito\n",
    "; Loading \"mito\"\n",
    "....\n",
    "T\n",
    "CL-USER> (in-package :classstarter)\n",
    "#<PACKAGE \"CLASSSTARTER\">\n",
    "CLASSSTARTER> (setf role-namen '(\"Instructor\" \"Student\"))\n",
    "; in: SETF ROLE-NAMEN\n",
    ";     (SETF CLASSSTARTER::ROLE-NAMEN '(\"Instructor\" \"Student\"))\n",
    "; ==>\n",
    ";   (SETQ CLASSSTARTER::ROLE-NAMEN '(\"Instructor\" \"Student\"))\n",
    "; \n",
    "; caught WARNING:\n",
    ";   undefined variable: ROLE-NAMEN\n",
    "; \n",
    "; compilation unit finished\n",
    ";   Undefined variable:\n",
    ";     ROLE-NAMEN\n",
    ";   caught 1 WARNING condition\n",
    "(\"Instructor\" \"Student\")\n",
    "CLASSSTARTER> (create-roles role-namen)\n",
    "(\"Instructor\" \"Student\")\n",
    "CLASSSTARTER> ; Worked.  I checked in DB Browser\n",
    "; No values\n",
    "CLASSSTARTER> (create-person)\n",
    "; Debugger entered on #<SIMPLE-ERROR \"~@<When attempting to ~A, the slot ~S is missing from the ~\n",
    ";           object ~S.~@:>\" {1002BF79C3}>\n",
    "```\n",
    "## **In debugger:**\n",
    "\n",
    "```\n",
    "When attempting to read the slot's value (slot-value), the slot\n",
    "MITO.DAO.MIXIN::ID is missing from the object 1.\n",
    "   [Condition of type SIMPLE-ERROR]\n",
    "\n",
    "Restarts:\n",
    " 0: [RETRY] Retry SLY mREPL evaluation request.\n",
    " 1: [*ABORT] Return to SLY's top level.\n",
    " 2: [ABORT] abort thread (#<THREAD \"sly-channel-1-mrepl-remote-1\" RUNNING {1002916C03}>)\n",
    "\n",
    "Backtrace:\n",
    " 0: ((:METHOD SLOT-MISSING (T T T T)) #<unused argument> 1 MITO.DAO.MIXIN::ID SLOT-VALUE NIL) [fast-method]\n",
    " 1: (SLOT-VALUE 1 MITO.DAO.MIXIN::ID)\n",
    " 2: (MITO.DAO::FOREIGN-VALUE #<PERSON {10029043C3}> #<MITO.DAO.COLUMN:DAO-TABLE-COLUMN-CLASS CLASSSTARTER::ROLE-ID>)\n",
    " 3: (MITO.DAO::MAKE-SET-CLAUSE #<PERSON {10029043C3}>)\n",
    " 4: ((:METHOD INSERT-DAO (DAO-CLASS)) #<PERSON {10029043C3}>) [fast-method]\n",
    " 5: ((SB-PCL::EMF INSERT-DAO) #<unused argument> #<unused argument> #<PERSON {10029043C3}>)\n",
    " 6: (SB-INT:SIMPLE-EVAL-IN-LEXENV (CREATE-PERSON) #<NULL-LEXENV>)\n",
    " 7: (EVAL (CREATE-PERSON))\n",
    " 8: ((LAMBDA NIL :IN SLYNK-MREPL::MREPL-EVAL-1))\n",
    " --more--\n",
    "\n",
    "```\n",
    "\n",
    "How should I change either a class definition or a function to create a **person**?\n",
    "\n",
    "# Thanks!\n",
    "\n",
    "Jud"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.6"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
